# id:D4E5F6A7-B8C9-0123-DEF0-456789012345
name: Bump Formulas

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      formula:
        description: "Specific formula to check (leave empty for all)"
        required: false
        type: string
      force:
        description: "Force check even if PR already exists"
        required: false
        default: false
        type: boolean

concurrency:
  group: bump-formulas
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  bump-formulas:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from 1Password
        id: op-secrets
        uses: 1password/load-secrets-action@v3
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          X_REPO_AUTH_APP_ID: op://gh-shared/xauth/app/id
          X_REPO_AUTH_PRIVATE_KEY: op://gh-shared/xauth/app/private-key.pem

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ steps.op-secrets.outputs.X_REPO_AUTH_APP_ID }}
          private-key: ${{ steps.op-secrets.outputs.X_REPO_AUTH_PRIVATE_KEY }}

      - name: Bump Homebrew formulas
        uses: dawidd6/action-homebrew-bump-formula@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          tap: aRustyDev/tap
          formula: ${{ inputs.formula }}
          livecheck: true
          force: ${{ inputs.force || false }}
          no_fork: true
          user_name: "x-repo-auth[bot]"
          user_email: "2608951+x-repo-auth[bot]@users.noreply.github.com"
